{% extends 'dashboard/base.html' %} {% load static %} {% block content %}
<div class="row">
  <div class="position-relative z-index-2">
    <div class="card card-plain mb-4 border-0">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-lg-6">
            <div class="d-flex flex-column h-100">
              <h2 class="font-weight-bolder mb-0">Start Scraping</h2>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-12 mb-lg-0 mb-4">
      <div class="card z-index-2 mt-4">
        <div class="card-body px-3">
          <div class="shadow-dark border-radius-lg py-3 pe-1 mb-3">
            <div class="row px-3">
              <form role="form" action="" method="post">
                {% csrf_token %}
                <div class="row">
                  <div class="col-lg-10">
                    <div class="ms-md-auto pe-md-3 d-flex align-items-center">
                      <div class="input-group input-group-outline">
                        <label class="form-label">Type URL here...</label>
                        <input
                          type="text"
                          id="url_input"
                          class="form-control"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-2">
                    <div class="row">
                      <button
                        class="btn btn-outline-primary w-100"
                        id="add_button"
                        type="submit"
                      >
                        <i class="bi bi-plus"></i>
                        &nbsp;Add
                      </button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- datatable -->
          <div class="shadow-dark border-radius-lg py-3 px-3 mb-3">
            <!-- url_list.html -->
            <table id="urlTable" class="table-sm table-striped">
              <thead>
                <tr>
                  <th class="col-lg-1">Id</th>
                  <th class="col-lg-7">URL</th>
                  <th class="col-lg-2">Is Scraped</th>
                  <th class="col-lg-2">Action</th>
                  <th class="col-lg-2">Is Created</th>
                  <th class="col-lg-2">Status</th>
                </tr>
              </thead>
              <tbody>
                {% for url in all_urls %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ url.url }}</td>
                  <td>{{ url.is_scraped }}</td>
                  <td>
                    {% if not url.is_scraped %}
                    <button
                      class="btn btn-outline-info btn-md scrape-button"
                      style="margin: 0px; padding: 0px; border: 0"
                      id="{{ url.url }}"
                    >
                      <i class="bi bi-download"></i>
                    </button>
                    {% else %}
                    <i class="bi bi-check-square"></i>
                    {% endif %}
                  </td>
                  <td>{{ url.is_created }}</td>
                  <td>
                    {% if not url.is_created %}
                    <button
                      class="btn btn-outline-info btn-md create-button"
                      style="margin: 0px; padding: 0px; border: 0"
                      id="{{ url.url }}"
                    >
                      <i class="bi bi-download"></i>
                    </button>
                    {% else %}
                    <i class="bi bi-check-square"></i>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading dialog (Bootstrap modal) -->
  <div id="loadingDialog" class="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div
        class="modal-content"
        style="background-color: transparent; border: none"
      >
        <div class="modal-body text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block script %}

<script type="text/javascript">
  $(document).ready(function () {
    var dataTable = $("#urlTable").DataTable();

    // add url button
    $("#add_button").click(function (event) {
      event.preventDefault();

      $("#loadingDialog").modal("show");

      // Disable background interaction
      $("body").addClass("modal-open");
      url = $("#url_input").val();
      // If only one tag is present, directly execute AJAX call for that tag
      var formData = new FormData();
      formData.append("url", url);
      var view_url = "/crm/add_url/";
      console.log("<------url_input-------->", url);
      executeAjaxCall(formData, view_url);
    });

    // scrape url button
    console.log("before scrape");
    $(".scrape-button").click(function () {
      console.log("after scrape");
      var url = $(this).attr("id");
      console.log(url);
      event.preventDefault();

      $("#loadingDialog").modal("show");

      // Disable background interaction
      $("body").addClass("modal-open");

      var formData = new FormData();
      formData.append("url", url);
      var view_url = "/crm/scrape_post/";
      executeAjaxCall(formData, view_url);
    });

    // Create new post for blog home page
    $(".create-button").click(function () {
      var url = $(this).attr("id");
      console.log(url);
      event.preventDefault();

      $("#loadingDialog").modal("show");

      // Disable background interaction
      $("body").addClass("modal-open");

      var formData = new FormData();
      formData.append("url", url);
      var view_url = "/crm/create_post/";
      executeAjaxCall(formData, view_url);
    });

    // Remove tag when close button is clicked
    $(document).on("click", ".close", function () {
      $(this).parent().remove();
    });

    // ajax call function
    function executeAjaxCall(formData, view_url) {
      $.ajax({
        url: view_url,
        type: "POST",
        data: formData,
        cache: false,
        processData: false, // essential
        contentType: false, // essential, application/pdf doesn't work.

        // If sucess, download file
        success: function (data, status, xhr) {
          if (status != 500) {
            console.log("<----------------add url success------------>");
            console.log(data);
            // Clear input field
            $("#url_input").val("");

            // Refresh DataTable
            location.reload();
          }
        },
        complete: function () {
          // Hide loading spinner when AJAX request completes (either success or error)
          $("#loadingDialog").modal("hide");

          // Enable background interaction
          $("body").removeClass("modal-open");
        },
      });
    }
  });
</script>

{% endblock %}
